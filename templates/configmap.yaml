apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tetrate-pre-check-tool.fullname" . }}-scripts
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "tetrate-pre-check-tool.labels" . | nindent 4 }}
data:
  run-precheck.sh: |
    #!/bin/sh
    set -e
    
    echo "==================================="
    echo "Tetrate Istio Pre-Check Tool"
    echo "==================================="
    echo "Started at: $(date)"
    echo ""
    
    # Install required tools
    echo "Installing required tools..."
    apk add --no-cache curl kubectl jq > /dev/null 2>&1
    
    # Install Helm (optional, for checking Helm-based installations)
    echo "Installing Helm..."
    curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | sh > /dev/null 2>&1 || echo "Helm installation skipped"
    
    # Download istioctl
    echo "Downloading istioctl version ${ISTIOCTL_VERSION}..."
    curl -sL https://istio.io/downloadIstio | ISTIO_VERSION=${ISTIOCTL_VERSION} sh - > /dev/null 2>&1
    cp istio-${ISTIOCTL_VERSION}/bin/istioctl /usr/local/bin/
    chmod +x /usr/local/bin/istioctl
    echo "istioctl installed successfully"
    echo ""
    
    # Output file
    OUTPUT_FILE="/output/tetrate-pre-check-tool.log"
    
    # Start logging
    exec > >(tee -a ${OUTPUT_FILE}) 2>&1
    
    echo "==================================="
    echo "ISTIO INSTALLATION METHOD CHECK"
    echo "==================================="
    echo "--- Check if Istio Operator is installed ---"
    kubectl get pods -A | grep istio-operator || echo "No Istio Operator pods found"
    echo ""
    
    echo "--- Check if IstioOperator CRD or resources exist ---"
    kubectl get crd | grep istiooperator || echo "No IstioOperator CRD found"
    echo ""
    kubectl get istiooperators.install.istio.io -A 2>&1 || echo "No IstioOperator resources found"
    echo ""
    
    echo "--- Check if Helm was used to install Istio ---"
    kubectl get all -n istio-system -o yaml 2>/dev/null | grep "helm.sh/chart" || echo "No Helm chart labels found"
    echo ""
    helm list -A 2>/dev/null | grep istio || echo "No Istio Helm releases found (helm may not be available in pod)"
    echo ""
    
    echo "==================================="
    echo "ISTIO VERSION CHECK"
    echo "==================================="
    echo "--- Local istioctl version ---"
    istioctl version --short --remote=false 2>&1 || {
      echo "Standard version command failed, trying alternative..."
      istioctl version --output json 2>&1 | grep -E '(clientVersion|version)' || echo "Unable to determine istioctl version"
    }
    echo ""
    
    echo "--- Remote Istio version (CLI + control plane) ---"
    istioctl version 2>&1 || {
      echo "Full version command failed, trying alternatives..."
      # Try to get version from istiod deployment labels
      ISTIOD_VERSION=$(kubectl get deploy -n istio-system -l app=istiod -o jsonpath='{.items[0].metadata.labels.version}' 2>/dev/null)
      if [ -n "$ISTIOD_VERSION" ]; then
        echo "Istio version (from istiod deployment): $ISTIOD_VERSION"
      fi
      
      # Check istiod image tag
      ISTIOD_IMAGE=$(kubectl get deploy -n istio-system -l app=istiod -o jsonpath='{.items[0].spec.template.spec.containers[0].image}' 2>/dev/null)
      if [ -n "$ISTIOD_IMAGE" ]; then
        echo "Istiod image: $ISTIOD_IMAGE"
      fi
    }
    echo ""
    
    echo "--- Istiod container image version ---"
    kubectl get pods -n istio-system -l app=istiod -o jsonpath='{.items[*].spec.containers[*].image}' 2>&1 || echo "Unable to get istiod image"
    echo ""
    echo ""
    
    echo "--- Dump current Istio profile configuration ---"
    istioctl profile dump 2>&1 || echo "Profile dump command failed (may require higher permissions)"
    echo ""
    
    echo "==================================="
    echo "CONTROL PLANE COMPONENTS"
    echo "==================================="
    echo "--- Pods in istio-system namespace ---"
    kubectl get pods -n istio-system || echo "No pods found or namespace doesn't exist"
    echo ""
    
    echo "--- Deployments in istio-system namespace ---"
    kubectl get deploy -n istio-system || echo "No deployments found or namespace doesn't exist"
    echo ""
    
    echo "--- Services in istio-system namespace ---"
    kubectl get svc -n istio-system || echo "No services found or namespace doesn't exist"
    echo ""
    
    echo "==================================="
    echo "ISTIOD REVISIONS AND NAMESPACE LABELS"
    echo "==================================="
    echo "--- Istiod deployments with revisions ---"
    kubectl get deploy -n istio-system -l app=istiod -o custom-columns="NAME:.metadata.name,REVISION:.metadata.labels.istio\.io/rev" 2>/dev/null || echo "No istiod deployments found"
    echo ""
    
    echo "--- Namespace labels for Istio injection ---"
    kubectl get ns -L istio.io/rev -L istio-injection || echo "Failed to get namespace labels"
    echo ""
    
    echo "--- Check namespace injection labels (alternative view) ---"
    kubectl get namespace -L istio-injection 2>&1 || echo "Failed to get namespace injection labels"
    echo ""
    
    echo "==================================="
    echo "SIDECAR INJECTION VERIFICATION"
    echo "==================================="
    echo "--- Pods with istio-proxy sidecar ---"
    kubectl get pods -A -o jsonpath='{range .items[*]}{.metadata.namespace}{"\t"}{.metadata.name}{"\t"}{.spec.containers[*].name}{"\n"}{end}' | grep istio-proxy || echo "No pods with istio-proxy found"
    echo ""
    
    echo "==================================="
    echo "CONTROL PLANE HEALTH VALIDATION"
    echo "==================================="
    echo "--- Proxy status ---"
    istioctl proxy-status 2>&1 || echo "Proxy status command failed or no proxies found"
    echo ""
    
    echo "--- Istio configuration analysis ---"
    istioctl analyze -A 2>&1 || echo "Analysis command failed"
    echo ""
    
    echo "--- Validating webhook configurations ---"
    kubectl get validatingwebhookconfigurations.admissionregistration.k8s.io | grep istio || echo "No Istio validating webhooks found"
    echo ""
    
    echo "--- Mutating webhook configurations ---"
    kubectl get mutatingwebhookconfigurations.admissionregistration.k8s.io | grep istio || echo "No Istio mutating webhooks found"
    echo ""
    
    echo "==================================="
    echo "GATEWAY DEPLOYMENTS"
    echo "==================================="
    echo "--- Ingress/Egress gateway deployments and services ---"
    kubectl get deploy,svc -n istio-system | grep gateway || echo "No gateway deployments/services found"
    echo ""
    
    echo "--- Ingress gateway pods ---"
    kubectl get pods -A -l istio=ingressgateway || echo "No ingress gateway pods found"
    echo ""
    
    echo "--- Ingress gateway services ---"
    kubectl get svc -A -l istio=ingressgateway || echo "No ingress gateway services found"
    echo ""
    
    echo "==================================="
    echo "ISTIO CUSTOM RESOURCES"
    echo "==================================="
    echo "--- Istio CRDs ---"
    kubectl get crds | grep istio.io || echo "No Istio CRDs found"
    echo ""
    
    echo "--- Istio custom resources ---"
    kubectl get virtualservices,destinationrules,gateways,gw,serviceentries,peerauthentications,authorizationpolicies -A || echo "No Istio custom resources found"
    echo ""
    
    echo "==================================="
    echo "CLUSTER CONTEXT"
    echo "==================================="
    echo "--- All namespaces ---"
    kubectl get ns
    echo ""
    
    echo "--- All pods with 'istio' in name ---"
    kubectl get pods -A | grep istio || echo "No pods with 'istio' in name found"
    echo ""
    
    echo "--- Istio ConfigMap (full configuration) ---"
    kubectl get cm -n istio-system istio -o yaml 2>/dev/null || echo "Istio ConfigMap not found"
    echo ""
    
    echo "==================================="
    echo "Pre-check completed at: $(date)"
    echo "==================================="
    echo ""
    echo "Output saved to: ${OUTPUT_FILE}"
    echo "Keeping pod alive for log retrieval. Use 'kubectl cp' to download the log file."
    echo ""
    
    # Keep the pod running so logs can be retrieved
    echo "Pod will remain running. Delete the pod manually when done."
    tail -f /dev/null